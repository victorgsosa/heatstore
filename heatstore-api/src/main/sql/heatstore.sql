DROP VIEW "SYSTEM"."DETECTIONS_COUNT";
DROP TABLE "SYSTEM"."DETECTION";
DROP TABLE "SYSTEM"."IMAGE";
DROP TABLE "SYSTEM"."ROLE_ACTIONS";
DROP TABLE "SYSTEM"."ROLE";
DROP TABLE "SYSTEM"."ACTION";
DROP TABLE "SYSTEM"."CAMERA_ROLES";
DROP TABLE "SYSTEM"."CAMERA";
DROP TABLE "SYSTEM"."PERSON";

CREATE ROW TABLE "SYSTEM"."CAMERA"(
	"ID" VARCHAR(36) CS_STRING,
	"HEIGHT" DOUBLE CS_DOUBLE,
	"FOCAL_LENGTH" DOUBLE CS_DOUBLE,
	"A_DISTANCE" DOUBLE CS_DOUBLE,
	"AX" DOUBLE CS_DOUBLE,
	"AY" DOUBLE CS_DOUBLE,
	"B_DISTANCE" DOUBLE CS_DOUBLE,
	"BX" DOUBLE CS_DOUBLE,
	"BY" DOUBLE CS_DOUBLE,
	"C_DISTANCE" DOUBLE CS_DOUBLE,
	"CX" DOUBLE CS_DOUBLE,
	"CY" DOUBLE CS_DOUBLE,
	PRIMARY KEY (
		"ID"
	)
);

CREATE COLUMN TABLE "SYSTEM"."IMAGE"(
	"ID" BIGINT CS_FIXED NOT NULL GENERATED BY DEFAULT AS IDENTITY,
	"DATE" LONGDATE CS_LONGDATE NOT NULL,
	"CAMERA_ID" VARCHAR(36),
	PRIMARY KEY (
		"ID"
	)
) UNLOAD PRIORITY 5 AUTO MERGE;
ALTER TABLE "SYSTEM"."IMAGE" ADD FOREIGN KEY ( "CAMERA_ID" ) REFERENCES "SYSTEM"."CAMERA" ("ID") ON UPDATE RESTRICT ON DELETE RESTRICT;

CREATE COLUMN TABLE  "SYSTEM"."DETECTION" ("ID" BIGINT CS_FIXED GENERATED BY DEFAULT AS IDENTITY NOT NULL ,
	 "IMAGE_ID" BIGINT CS_FIXED NOT NULL ,
	 "SCORE" DOUBLE CS_DOUBLE,
	 "X_MIN" DOUBLE CS_DOUBLE,
	 "Y_MIN" DOUBLE CS_DOUBLE,
	 "X_MAX" DOUBLE CS_DOUBLE,
	 "Y_MAX" DOUBLE CS_DOUBLE,
	 "X" DOUBLE CS_DOUBLE,
	 "Y" DOUBLE CS_DOUBLE,
	 PRIMARY KEY ("ID")) UNLOAD PRIORITY 5 AUTO MERGE;
ALTER TABLE "SYSTEM"."DETECTION" ADD FOREIGN KEY ( "IMAGE_ID" ) REFERENCES "SYSTEM"."IMAGE" ("ID") ON UPDATE CASCADE ON DELETE CASCADE;


CREATE VIEW  "SYSTEM"."DETECTIONS_COUNT" ( "YEAR",
	 "MONTH",
	 "DAY",
	 "HOUR",
	 "DATE",
	 "X_REGION",
	 "Y_REGION",
	 "X_START",
	 "X_END",
	 "Y_START",
	 "Y_END",
	 "COUNT" ) AS SELECT
	 "YEAR",
	 "MONTH",
	 "DAY",
	 "HOUR",
	 "DATE",
	 "X_REGION",
	 "Y_REGION",
	 "X_REGION" * 0.1 AS "X_START",
	 ("X_REGION" + 1 ) * 0.1 AS "X_END",
	 "Y_REGION" * 0.1 AS "Y_START",
	 ("Y_REGION" + 1 ) * 0.1 AS "Y_END",
	 COUNT(*) AS "COUNT" 
FROM ( SELECT
	 YEAR( I."DATE" ) AS "YEAR",
	 MONTH( I."DATE") AS "MONTH",
	 DAYOFMONTH( I."DATE" ) AS "DAY",
	 HOUR( I."DATE") AS "HOUR",
	 TO_DATE(I."DATE") AS "DATE",
	 FLOOR( D."X" / 0.1 ) AS "X_REGION",
	 FLOOR( D."Y" / 0.1 ) AS "Y_REGION" 
	FROM DETECTION AS D 
	LEFT OUTER JOIN IMAGE AS I ON D."IMAGE_ID" = I."ID" ) 
GROUP BY "YEAR",
	 "MONTH",
	 "DAY",
	 "HOUR",
	 "DATE",
	 "X_REGION",
	 "Y_REGION" WITH READ ONLY;

CREATE ROW TABLE  "SYSTEM"."ROLE" ( "ID" VARCHAR(20) CS_STRING,
	 "DESCRIPTION" VARCHAR(255) CS_STRING,
	 PRIMARY KEY ( "ID" ) ) ;


CREATE ROW TABLE  "SYSTEM"."ACTION" ( "ID" VARCHAR(20) CS_STRING,
	 "DESCRIPTION" VARCHAR(255) CS_STRING,
	 PRIMARY KEY ( "ID" ) );

CREATE ROW TABLE "SYSTEM"."ROLE_ACTIONS"  ( 
	"ROLE_ID" VARCHAR(20) CS_STRING, 
	"ACTION_ID" VARCHAR(20) CS_STRING, 
	PRIMARY KEY ( "ROLE_ID", "ACTION_ID" ) ) ;
ALTER TABLE "SYSTEM"."ROLE_ACTIONS" ADD FOREIGN KEY ( "ROLE_ID" ) REFERENCES "SYSTEM"."ROLE" ("ID") ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE "SYSTEM"."ROLE_ACTIONS" ADD FOREIGN KEY ( "ACTION_ID" ) REFERENCES "SYSTEM"."ACTION" ("ID") ON UPDATE RESTRICT ON DELETE RESTRICT;





CREATE ROW TABLE "SYSTEM"."CAMERA_ROLES"  ( 
	"CAMERA_ID" VARCHAR(36) CS_STRING, 
	"ROLE_ID" VARCHAR(20) CS_STRING, 
	PRIMARY KEY ( "CAMERA_ID", "ROLE_ID" )) ;
ALTER TABLE "SYSTEM"."CAMERA_ROLES" ADD FOREIGN KEY ( "CAMERA_ID" ) REFERENCES "SYSTEM"."CAMERA" ("ID") ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE "SYSTEM"."CAMERA_ROLES" ADD FOREIGN KEY ( "ROLE_ID" ) REFERENCES "SYSTEM"."ROLE" ("ID") ON UPDATE RESTRICT ON DELETE RESTRICT;



insert into "SYSTEM"."ROLE" values('COUNTER_IN','Counts entering persons');
insert into "SYSTEM"."ROLE" values('COUNTER_OUT','Counts leaving persons');
insert into "SYSTEM"."ROLE" values('CLASSIFICATOR','Counts entering persons');
insert into "SYSTEM"."ROLE" values('LOCATOR','Counts entering persons');

insert into "SYSTEM"."ACTION" values('DETECTION','Detects persons');
insert into "SYSTEM"."ACTION" values('LOCATION','Location of detections in image');
insert into "SYSTEM"."ACTION" values('CROP','Crop detections in image');
insert into "SYSTEM"."ACTION" values('EMBEDDINGS','Map a person into face embeddings');
insert into "SYSTEM"."ACTION" values('CLASSIFY','Add metadata to person embeddings');

insert into "SYSTEM"."ROLE_ACTIONS" values('COUNTER_IN','DETECTION');
insert into "SYSTEM"."ROLE_ACTIONS" values('COUNTER_IN','CROP');
insert into "SYSTEM"."ROLE_ACTIONS" values('COUNTER_IN','EMBEDDINGS');
insert into "SYSTEM"."ROLE_ACTIONS" values('COUNTER_OUT','DETECTION');
insert into "SYSTEM"."ROLE_ACTIONS" values('COUNTER_OUT','CROP');
insert into "SYSTEM"."ROLE_ACTIONS" values('COUNTER_OUT','EMBEDDINGS');
insert into "SYSTEM"."ROLE_ACTIONS" values('CLASSIFICATOR','DETECTION');
insert into "SYSTEM"."ROLE_ACTIONS" values('CLASSIFICATOR','CROP');
insert into "SYSTEM"."ROLE_ACTIONS" values('CLASSIFICATOR','EMBEDDINGS');
insert into "SYSTEM"."ROLE_ACTIONS" values('CLASSIFICATOR','CLASSIFY');
insert into "SYSTEM"."ROLE_ACTIONS" values('LOCATOR','DETECTION');
insert into "SYSTEM"."ROLE_ACTIONS" values('LOCATOR','LOCATION');


CREATE COLUMN TABLE "SYSTEM"."PERSON"(
	"ID" BIGINT CS_FIXED NOT NULL GENERATED BY DEFAULT AS IDENTITY,
	"FIRST_SEEN_ON" LONGDATE CS_LONGDATE NOT NULL,
	"LAST_SEEN_ON" LONGDATE CS_LONGDATE NOT NULL,
	PRIMARY KEY (
		"ID"
	)
) UNLOAD PRIORITY 5 AUTO MERGE;

CREATE COLUMN TABLE "SYSTEM"."PERSON_EMBEDDINGS" (
	"PERSON_ID" BIGINT CS_FIXED NOT NULL , 
	"SEQ" INTEGER CS_INT NOT NULL , 
	"VALUE" DOUBLE CS_DOUBLE NOT NULL , 
	PRIMARY KEY INVERTED VALUE ("PERSON_ID", "SEQ")) UNLOAD PRIORITY 5  AUTO MERGE ;

ALTER TABLE "SYSTEM"."PERSON_EMBEDDINGS" ADD FOREIGN KEY ( "PERSON_ID" ) REFERENCES "SYSTEM"."PERSON" ("ID") ON UPDATE RESTRICT ON DELETE RESTRICT;


CREATE TYPE SYSTEM.EMBEDDINGS AS TABLE(SEQ INT, VALUE DOUBLE);


CREATE COLUMN TABLE "SYSTEM"."PERSON_CLASSIFIER" (
	"PERSON_ID" BIGINT CS_FIXED, "NAME" VARCHAR(20), 
	"VALUE" DOUBLE CS_DOUBLE, 
	PRIMARY KEY INVERTED VALUE ("PERSON_ID", "NAME")) UNLOAD PRIORITY 5  AUTO MERGE ;

ALTER TABLE "SYSTEM"."PERSON_CLASSIFIER" ADD FOREIGN KEY ( "PERSON_ID" ) REFERENCES "SYSTEM"."PERSON" ("ID") ON UPDATE RESTRICT ON DELETE RESTRICT;

CREATE PROCEDURE "SYSTEM"."FIND_NEAR_PERSONS"(
    IN VAL1 DOUBLE,
IN VAL2 DOUBLE,
IN VAL3 DOUBLE,
IN VAL4 DOUBLE,
IN VAL5 DOUBLE,
IN VAL6 DOUBLE,
IN VAL7 DOUBLE,
IN VAL8 DOUBLE,
IN VAL9 DOUBLE,
IN VAL10 DOUBLE,
IN VAL11 DOUBLE,
IN VAL12 DOUBLE,
IN VAL13 DOUBLE,
IN VAL14 DOUBLE,
IN VAL15 DOUBLE,
IN VAL16 DOUBLE,
IN VAL17 DOUBLE,
IN VAL18 DOUBLE,
IN VAL19 DOUBLE,
IN VAL20 DOUBLE,
IN VAL21 DOUBLE,
IN VAL22 DOUBLE,
IN VAL23 DOUBLE,
IN VAL24 DOUBLE,
IN VAL25 DOUBLE,
IN VAL26 DOUBLE,
IN VAL27 DOUBLE,
IN VAL28 DOUBLE,
IN VAL29 DOUBLE,
IN VAL30 DOUBLE,
IN VAL31 DOUBLE,
IN VAL32 DOUBLE,
IN VAL33 DOUBLE,
IN VAL34 DOUBLE,
IN VAL35 DOUBLE,
IN VAL36 DOUBLE,
IN VAL37 DOUBLE,
IN VAL38 DOUBLE,
IN VAL39 DOUBLE,
IN VAL40 DOUBLE,
IN VAL41 DOUBLE,
IN VAL42 DOUBLE,
IN VAL43 DOUBLE,
IN VAL44 DOUBLE,
IN VAL45 DOUBLE,
IN VAL46 DOUBLE,
IN VAL47 DOUBLE,
IN VAL48 DOUBLE,
IN VAL49 DOUBLE,
IN VAL50 DOUBLE,
IN VAL51 DOUBLE,
IN VAL52 DOUBLE,
IN VAL53 DOUBLE,
IN VAL54 DOUBLE,
IN VAL55 DOUBLE,
IN VAL56 DOUBLE,
IN VAL57 DOUBLE,
IN VAL58 DOUBLE,
IN VAL59 DOUBLE,
IN VAL60 DOUBLE,
IN VAL61 DOUBLE,
IN VAL62 DOUBLE,
IN VAL63 DOUBLE,
IN VAL64 DOUBLE,
IN VAL65 DOUBLE,
IN VAL66 DOUBLE,
IN VAL67 DOUBLE,
IN VAL68 DOUBLE,
IN VAL69 DOUBLE,
IN VAL70 DOUBLE,
IN VAL71 DOUBLE,
IN VAL72 DOUBLE,
IN VAL73 DOUBLE,
IN VAL74 DOUBLE,
IN VAL75 DOUBLE,
IN VAL76 DOUBLE,
IN VAL77 DOUBLE,
IN VAL78 DOUBLE,
IN VAL79 DOUBLE,
IN VAL80 DOUBLE,
IN VAL81 DOUBLE,
IN VAL82 DOUBLE,
IN VAL83 DOUBLE,
IN VAL84 DOUBLE,
IN VAL85 DOUBLE,
IN VAL86 DOUBLE,
IN VAL87 DOUBLE,
IN VAL88 DOUBLE,
IN VAL89 DOUBLE,
IN VAL90 DOUBLE,
IN VAL91 DOUBLE,
IN VAL92 DOUBLE,
IN VAL93 DOUBLE,
IN VAL94 DOUBLE,
IN VAL95 DOUBLE,
IN VAL96 DOUBLE,
IN VAL97 DOUBLE,
IN VAL98 DOUBLE,
IN VAL99 DOUBLE,
IN VAL100 DOUBLE,
IN VAL101 DOUBLE,
IN VAL102 DOUBLE,
IN VAL103 DOUBLE,
IN VAL104 DOUBLE,
IN VAL105 DOUBLE,
IN VAL106 DOUBLE,
IN VAL107 DOUBLE,
IN VAL108 DOUBLE,
IN VAL109 DOUBLE,
IN VAL110 DOUBLE,
IN VAL111 DOUBLE,
IN VAL112 DOUBLE,
IN VAL113 DOUBLE,
IN VAL114 DOUBLE,
IN VAL115 DOUBLE,
IN VAL116 DOUBLE,
IN VAL117 DOUBLE,
IN VAL118 DOUBLE,
IN VAL119 DOUBLE,
IN VAL120 DOUBLE,
IN VAL121 DOUBLE,
IN VAL122 DOUBLE,
IN VAL123 DOUBLE,
IN VAL124 DOUBLE,
IN VAL125 DOUBLE,
IN VAL126 DOUBLE,
IN VAL127 DOUBLE,
IN VAL128 DOUBLE,
IN VAL129 DOUBLE,
IN VAL130 DOUBLE,
IN VAL131 DOUBLE,
IN VAL132 DOUBLE,
IN VAL133 DOUBLE,
IN VAL134 DOUBLE,
IN VAL135 DOUBLE,
IN VAL136 DOUBLE,
IN VAL137 DOUBLE,
IN VAL138 DOUBLE,
IN VAL139 DOUBLE,
IN VAL140 DOUBLE,
IN VAL141 DOUBLE,
IN VAL142 DOUBLE,
IN VAL143 DOUBLE,
IN VAL144 DOUBLE,
IN VAL145 DOUBLE,
IN VAL146 DOUBLE,
IN VAL147 DOUBLE,
IN VAL148 DOUBLE,
IN VAL149 DOUBLE,
IN VAL150 DOUBLE,
IN VAL151 DOUBLE,
IN VAL152 DOUBLE,
IN VAL153 DOUBLE,
IN VAL154 DOUBLE,
IN VAL155 DOUBLE,
IN VAL156 DOUBLE,
IN VAL157 DOUBLE,
IN VAL158 DOUBLE,
IN VAL159 DOUBLE,
IN VAL160 DOUBLE,
IN VAL161 DOUBLE,
IN VAL162 DOUBLE,
IN VAL163 DOUBLE,
IN VAL164 DOUBLE,
IN VAL165 DOUBLE,
IN VAL166 DOUBLE,
IN VAL167 DOUBLE,
IN VAL168 DOUBLE,
IN VAL169 DOUBLE,
IN VAL170 DOUBLE,
IN VAL171 DOUBLE,
IN VAL172 DOUBLE,
IN VAL173 DOUBLE,
IN VAL174 DOUBLE,
IN VAL175 DOUBLE,
IN VAL176 DOUBLE,
IN VAL177 DOUBLE,
IN VAL178 DOUBLE,
IN VAL179 DOUBLE,
IN VAL180 DOUBLE,
IN VAL181 DOUBLE,
IN VAL182 DOUBLE,
IN VAL183 DOUBLE,
IN VAL184 DOUBLE,
IN VAL185 DOUBLE,
IN VAL186 DOUBLE,
IN VAL187 DOUBLE,
IN VAL188 DOUBLE,
IN VAL189 DOUBLE,
IN VAL190 DOUBLE,
IN VAL191 DOUBLE,
IN VAL192 DOUBLE,
IN VAL193 DOUBLE,
IN VAL194 DOUBLE,
IN VAL195 DOUBLE,
IN VAL196 DOUBLE,
IN VAL197 DOUBLE,
IN VAL198 DOUBLE,
IN VAL199 DOUBLE,
IN VAL200 DOUBLE,
IN VAL201 DOUBLE,
IN VAL202 DOUBLE,
IN VAL203 DOUBLE,
IN VAL204 DOUBLE,
IN VAL205 DOUBLE,
IN VAL206 DOUBLE,
IN VAL207 DOUBLE,
IN VAL208 DOUBLE,
IN VAL209 DOUBLE,
IN VAL210 DOUBLE,
IN VAL211 DOUBLE,
IN VAL212 DOUBLE,
IN VAL213 DOUBLE,
IN VAL214 DOUBLE,
IN VAL215 DOUBLE,
IN VAL216 DOUBLE,
IN VAL217 DOUBLE,
IN VAL218 DOUBLE,
IN VAL219 DOUBLE,
IN VAL220 DOUBLE,
IN VAL221 DOUBLE,
IN VAL222 DOUBLE,
IN VAL223 DOUBLE,
IN VAL224 DOUBLE,
IN VAL225 DOUBLE,
IN VAL226 DOUBLE,
IN VAL227 DOUBLE,
IN VAL228 DOUBLE,
IN VAL229 DOUBLE,
IN VAL230 DOUBLE,
IN VAL231 DOUBLE,
IN VAL232 DOUBLE,
IN VAL233 DOUBLE,
IN VAL234 DOUBLE,
IN VAL235 DOUBLE,
IN VAL236 DOUBLE,
IN VAL237 DOUBLE,
IN VAL238 DOUBLE,
IN VAL239 DOUBLE,
IN VAL240 DOUBLE,
IN VAL241 DOUBLE,
IN VAL242 DOUBLE,
IN VAL243 DOUBLE,
IN VAL244 DOUBLE,
IN VAL245 DOUBLE,
IN VAL246 DOUBLE,
IN VAL247 DOUBLE,
IN VAL248 DOUBLE,
IN VAL249 DOUBLE,
IN VAL250 DOUBLE,
IN VAL251 DOUBLE,
IN VAL252 DOUBLE,
IN VAL253 DOUBLE,
IN VAL254 DOUBLE,
IN VAL255 DOUBLE,
IN VAL256 DOUBLE,
IN VAL257 DOUBLE,
IN VAL258 DOUBLE,
IN VAL259 DOUBLE,
IN VAL260 DOUBLE,
IN VAL261 DOUBLE,
IN VAL262 DOUBLE,
IN VAL263 DOUBLE,
IN VAL264 DOUBLE,
IN VAL265 DOUBLE,
IN VAL266 DOUBLE,
IN VAL267 DOUBLE,
IN VAL268 DOUBLE,
IN VAL269 DOUBLE,
IN VAL270 DOUBLE,
IN VAL271 DOUBLE,
IN VAL272 DOUBLE,
IN VAL273 DOUBLE,
IN VAL274 DOUBLE,
IN VAL275 DOUBLE,
IN VAL276 DOUBLE,
IN VAL277 DOUBLE,
IN VAL278 DOUBLE,
IN VAL279 DOUBLE,
IN VAL280 DOUBLE,
IN VAL281 DOUBLE,
IN VAL282 DOUBLE,
IN VAL283 DOUBLE,
IN VAL284 DOUBLE,
IN VAL285 DOUBLE,
IN VAL286 DOUBLE,
IN VAL287 DOUBLE,
IN VAL288 DOUBLE,
IN VAL289 DOUBLE,
IN VAL290 DOUBLE,
IN VAL291 DOUBLE,
IN VAL292 DOUBLE,
IN VAL293 DOUBLE,
IN VAL294 DOUBLE,
IN VAL295 DOUBLE,
IN VAL296 DOUBLE,
IN VAL297 DOUBLE,
IN VAL298 DOUBLE,
IN VAL299 DOUBLE,
IN VAL300 DOUBLE,
IN VAL301 DOUBLE,
IN VAL302 DOUBLE,
IN VAL303 DOUBLE,
IN VAL304 DOUBLE,
IN VAL305 DOUBLE,
IN VAL306 DOUBLE,
IN VAL307 DOUBLE,
IN VAL308 DOUBLE,
IN VAL309 DOUBLE,
IN VAL310 DOUBLE,
IN VAL311 DOUBLE,
IN VAL312 DOUBLE,
IN VAL313 DOUBLE,
IN VAL314 DOUBLE,
IN VAL315 DOUBLE,
IN VAL316 DOUBLE,
IN VAL317 DOUBLE,
IN VAL318 DOUBLE,
IN VAL319 DOUBLE,
IN VAL320 DOUBLE,
IN VAL321 DOUBLE,
IN VAL322 DOUBLE,
IN VAL323 DOUBLE,
IN VAL324 DOUBLE,
IN VAL325 DOUBLE,
IN VAL326 DOUBLE,
IN VAL327 DOUBLE,
IN VAL328 DOUBLE,
IN VAL329 DOUBLE,
IN VAL330 DOUBLE,
IN VAL331 DOUBLE,
IN VAL332 DOUBLE,
IN VAL333 DOUBLE,
IN VAL334 DOUBLE,
IN VAL335 DOUBLE,
IN VAL336 DOUBLE,
IN VAL337 DOUBLE,
IN VAL338 DOUBLE,
IN VAL339 DOUBLE,
IN VAL340 DOUBLE,
IN VAL341 DOUBLE,
IN VAL342 DOUBLE,
IN VAL343 DOUBLE,
IN VAL344 DOUBLE,
IN VAL345 DOUBLE,
IN VAL346 DOUBLE,
IN VAL347 DOUBLE,
IN VAL348 DOUBLE,
IN VAL349 DOUBLE,
IN VAL350 DOUBLE,
IN VAL351 DOUBLE,
IN VAL352 DOUBLE,
IN VAL353 DOUBLE,
IN VAL354 DOUBLE,
IN VAL355 DOUBLE,
IN VAL356 DOUBLE,
IN VAL357 DOUBLE,
IN VAL358 DOUBLE,
IN VAL359 DOUBLE,
IN VAL360 DOUBLE,
IN VAL361 DOUBLE,
IN VAL362 DOUBLE,
IN VAL363 DOUBLE,
IN VAL364 DOUBLE,
IN VAL365 DOUBLE,
IN VAL366 DOUBLE,
IN VAL367 DOUBLE,
IN VAL368 DOUBLE,
IN VAL369 DOUBLE,
IN VAL370 DOUBLE,
IN VAL371 DOUBLE,
IN VAL372 DOUBLE,
IN VAL373 DOUBLE,
IN VAL374 DOUBLE,
IN VAL375 DOUBLE,
IN VAL376 DOUBLE,
IN VAL377 DOUBLE,
IN VAL378 DOUBLE,
IN VAL379 DOUBLE,
IN VAL380 DOUBLE,
IN VAL381 DOUBLE,
IN VAL382 DOUBLE,
IN VAL383 DOUBLE,
IN VAL384 DOUBLE,
IN VAL385 DOUBLE,
IN VAL386 DOUBLE,
IN VAL387 DOUBLE,
IN VAL388 DOUBLE,
IN VAL389 DOUBLE,
IN VAL390 DOUBLE,
IN VAL391 DOUBLE,
IN VAL392 DOUBLE,
IN VAL393 DOUBLE,
IN VAL394 DOUBLE,
IN VAL395 DOUBLE,
IN VAL396 DOUBLE,
IN VAL397 DOUBLE,
IN VAL398 DOUBLE,
IN VAL399 DOUBLE,
IN VAL400 DOUBLE,
IN VAL401 DOUBLE,
IN VAL402 DOUBLE,
IN VAL403 DOUBLE,
IN VAL404 DOUBLE,
IN VAL405 DOUBLE,
IN VAL406 DOUBLE,
IN VAL407 DOUBLE,
IN VAL408 DOUBLE,
IN VAL409 DOUBLE,
IN VAL410 DOUBLE,
IN VAL411 DOUBLE,
IN VAL412 DOUBLE,
IN VAL413 DOUBLE,
IN VAL414 DOUBLE,
IN VAL415 DOUBLE,
IN VAL416 DOUBLE,
IN VAL417 DOUBLE,
IN VAL418 DOUBLE,
IN VAL419 DOUBLE,
IN VAL420 DOUBLE,
IN VAL421 DOUBLE,
IN VAL422 DOUBLE,
IN VAL423 DOUBLE,
IN VAL424 DOUBLE,
IN VAL425 DOUBLE,
IN VAL426 DOUBLE,
IN VAL427 DOUBLE,
IN VAL428 DOUBLE,
IN VAL429 DOUBLE,
IN VAL430 DOUBLE,
IN VAL431 DOUBLE,
IN VAL432 DOUBLE,
IN VAL433 DOUBLE,
IN VAL434 DOUBLE,
IN VAL435 DOUBLE,
IN VAL436 DOUBLE,
IN VAL437 DOUBLE,
IN VAL438 DOUBLE,
IN VAL439 DOUBLE,
IN VAL440 DOUBLE,
IN VAL441 DOUBLE,
IN VAL442 DOUBLE,
IN VAL443 DOUBLE,
IN VAL444 DOUBLE,
IN VAL445 DOUBLE,
IN VAL446 DOUBLE,
IN VAL447 DOUBLE,
IN VAL448 DOUBLE,
IN VAL449 DOUBLE,
IN VAL450 DOUBLE,
IN VAL451 DOUBLE,
IN VAL452 DOUBLE,
IN VAL453 DOUBLE,
IN VAL454 DOUBLE,
IN VAL455 DOUBLE,
IN VAL456 DOUBLE,
IN VAL457 DOUBLE,
IN VAL458 DOUBLE,
IN VAL459 DOUBLE,
IN VAL460 DOUBLE,
IN VAL461 DOUBLE,
IN VAL462 DOUBLE,
IN VAL463 DOUBLE,
IN VAL464 DOUBLE,
IN VAL465 DOUBLE,
IN VAL466 DOUBLE,
IN VAL467 DOUBLE,
IN VAL468 DOUBLE,
IN VAL469 DOUBLE,
IN VAL470 DOUBLE,
IN VAL471 DOUBLE,
IN VAL472 DOUBLE,
IN VAL473 DOUBLE,
IN VAL474 DOUBLE,
IN VAL475 DOUBLE,
IN VAL476 DOUBLE,
IN VAL477 DOUBLE,
IN VAL478 DOUBLE,
IN VAL479 DOUBLE,
IN VAL480 DOUBLE,
IN VAL481 DOUBLE,
IN VAL482 DOUBLE,
IN VAL483 DOUBLE,
IN VAL484 DOUBLE,
IN VAL485 DOUBLE,
IN VAL486 DOUBLE,
IN VAL487 DOUBLE,
IN VAL488 DOUBLE,
IN VAL489 DOUBLE,
IN VAL490 DOUBLE,
IN VAL491 DOUBLE,
IN VAL492 DOUBLE,
IN VAL493 DOUBLE,
IN VAL494 DOUBLE,
IN VAL495 DOUBLE,
IN VAL496 DOUBLE,
IN VAL497 DOUBLE,
IN VAL498 DOUBLE,
IN VAL499 DOUBLE,
IN VAL500 DOUBLE,
IN VAL501 DOUBLE,
IN VAL502 DOUBLE,
IN VAL503 DOUBLE,
IN VAL504 DOUBLE,
IN VAL505 DOUBLE,
IN VAL506 DOUBLE,
IN VAL507 DOUBLE,
IN VAL508 DOUBLE,
IN VAL509 DOUBLE,
IN VAL510 DOUBLE,
IN VAL511 DOUBLE,
IN VAL512 DOUBLE,
IN THRESHOLD DOUBLE,
OUT PERSONS PERSON
)
LANGUAGE SQLSCRIPT
SQL SECURITY INVOKER 
READS SQL DATA WITH RESULT VIEW NEAR_PERSONS AS
BEGIN
    DECLARE seq INTEGER ARRAY := ARRAY(1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149,150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177,178,179,180,181,182,183,184,185,186,187,188,189,190,191,192,193,194,195,196,197,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224,225,226,227,228,229,230,231,232,233,234,235,236,237,238,239,240,241,242,243,244,245,246,247,248,249,250,251,252,253,254,255,256,257,258,259,260,261,262,263,264,265,266,267,268,269,270,271,272,273,274,275,276,277,278,279,280,281,282,283,284,285,286,287,288,289,290,291,292,293,294,295,296,297,298,299,300,301,302,303,304,305,306,307,308,309,310,311,312,313,314,315,316,317,318,319,320,321,322,323,324,325,326,327,328,329,330,331,332,333,334,335,336,337,338,339,340,341,342,343,344,345,346,347,348,349,350,351,352,353,354,355,356,357,358,359,360,361,362,363,364,365,366,367,368,369,370,371,372,373,374,375,376,377,378,379,380,381,382,383,384,385,386,387,388,389,390,391,392,393,394,395,396,397,398,399,400,401,402,403,404,405,406,407,408,409,410,411,412,413,414,415,416,417,418,419,420,421,422,423,424,425,426,427,428,429,430,431,432,433,434,435,436,437,438,439,440,441,442,443,444,445,446,447,448,449,450,451,452,453,454,455,456,457,458,459,460,461,462,463,464,465,466,467,468,469,470,471,472,473,474,475,476,477,478,479,480,481,482,483,484,485,486,487,488,489,490,491,492,493,494,495,496,497,498,499,500,501,502,503,504,505,506,507,508,509,510,511,512);
    DECLARE vals DOUBLE ARRAY := ARRAY(VAL1,VAL2,VAL3,VAL4,VAL5,VAL6,VAL7,VAL8,VAL9,VAL10,VAL11,VAL12,VAL13,VAL14,VAL15,VAL16,VAL17,VAL18,VAL19,VAL20,VAL21,VAL22,VAL23,VAL24,VAL25,VAL26,VAL27,VAL28,VAL29,VAL30,VAL31,VAL32,VAL33,VAL34,VAL35,VAL36,VAL37,VAL38,VAL39,VAL40,VAL41,VAL42,VAL43,VAL44,VAL45,VAL46,VAL47,VAL48,VAL49,VAL50,VAL51,VAL52,VAL53,VAL54,VAL55,VAL56,VAL57,VAL58,VAL59,VAL60,VAL61,VAL62,VAL63,VAL64,VAL65,VAL66,VAL67,VAL68,VAL69,VAL70,VAL71,VAL72,VAL73,VAL74,VAL75,VAL76,VAL77,VAL78,VAL79,VAL80,VAL81,VAL82,VAL83,VAL84,VAL85,VAL86,VAL87,VAL88,VAL89,VAL90,VAL91,VAL92,VAL93,VAL94,VAL95,VAL96,VAL97,VAL98,VAL99,VAL100,VAL101,VAL102,VAL103,VAL104,VAL105,VAL106,VAL107,VAL108,VAL109,VAL110,VAL111,VAL112,VAL113,VAL114,VAL115,VAL116,VAL117,VAL118,VAL119,VAL120,VAL121,VAL122,VAL123,VAL124,VAL125,VAL126,VAL127,VAL128,VAL129,VAL130,VAL131,VAL132,VAL133,VAL134,VAL135,VAL136,VAL137,VAL138,VAL139,VAL140,VAL141,VAL142,VAL143,VAL144,VAL145,VAL146,VAL147,VAL148,VAL149,VAL150,VAL151,VAL152,VAL153,VAL154,VAL155,VAL156,VAL157,VAL158,VAL159,VAL160,VAL161,VAL162,VAL163,VAL164,VAL165,VAL166,VAL167,VAL168,VAL169,VAL170,VAL171,VAL172,VAL173,VAL174,VAL175,VAL176,VAL177,VAL178,VAL179,VAL180,VAL181,VAL182,VAL183,VAL184,VAL185,VAL186,VAL187,VAL188,VAL189,VAL190,VAL191,VAL192,VAL193,VAL194,VAL195,VAL196,VAL197,VAL198,VAL199,VAL200,VAL201,VAL202,VAL203,VAL204,VAL205,VAL206,VAL207,VAL208,VAL209,VAL210,VAL211,VAL212,VAL213,VAL214,VAL215,VAL216,VAL217,VAL218,VAL219,VAL220,VAL221,VAL222,VAL223,VAL224,VAL225,VAL226,VAL227,VAL228,VAL229,VAL230,VAL231,VAL232,VAL233,VAL234,VAL235,VAL236,VAL237,VAL238,VAL239,VAL240,VAL241,VAL242,VAL243,VAL244,VAL245,VAL246,VAL247,VAL248,VAL249,VAL250,VAL251,VAL252,VAL253,VAL254,VAL255,VAL256,VAL257,VAL258,VAL259,VAL260,VAL261,VAL262,VAL263,VAL264,VAL265,VAL266,VAL267,VAL268,VAL269,VAL270,VAL271,VAL272,VAL273,VAL274,VAL275,VAL276,VAL277,VAL278,VAL279,VAL280,VAL281,VAL282,VAL283,VAL284,VAL285,VAL286,VAL287,VAL288,VAL289,VAL290,VAL291,VAL292,VAL293,VAL294,VAL295,VAL296,VAL297,VAL298,VAL299,VAL300,VAL301,VAL302,VAL303,VAL304,VAL305,VAL306,VAL307,VAL308,VAL309,VAL310,VAL311,VAL312,VAL313,VAL314,VAL315,VAL316,VAL317,VAL318,VAL319,VAL320,VAL321,VAL322,VAL323,VAL324,VAL325,VAL326,VAL327,VAL328,VAL329,VAL330,VAL331,VAL332,VAL333,VAL334,VAL335,VAL336,VAL337,VAL338,VAL339,VAL340,VAL341,VAL342,VAL343,VAL344,VAL345,VAL346,VAL347,VAL348,VAL349,VAL350,VAL351,VAL352,VAL353,VAL354,VAL355,VAL356,VAL357,VAL358,VAL359,VAL360,VAL361,VAL362,VAL363,VAL364,VAL365,VAL366,VAL367,VAL368,VAL369,VAL370,VAL371,VAL372,VAL373,VAL374,VAL375,VAL376,VAL377,VAL378,VAL379,VAL380,VAL381,VAL382,VAL383,VAL384,VAL385,VAL386,VAL387,VAL388,VAL389,VAL390,VAL391,VAL392,VAL393,VAL394,VAL395,VAL396,VAL397,VAL398,VAL399,VAL400,VAL401,VAL402,VAL403,VAL404,VAL405,VAL406,VAL407,VAL408,VAL409,VAL410,VAL411,VAL412,VAL413,VAL414,VAL415,VAL416,VAL417,VAL418,VAL419,VAL420,VAL421,VAL422,VAL423,VAL424,VAL425,VAL426,VAL427,VAL428,VAL429,VAL430,VAL431,VAL432,VAL433,VAL434,VAL435,VAL436,VAL437,VAL438,VAL439,VAL440,VAL441,VAL442,VAL443,VAL444,VAL445,VAL446,VAL447,VAL448,VAL449,VAL450,VAL451,VAL452,VAL453,VAL454,VAL455,VAL456,VAL457,VAL458,VAL459,VAL460,VAL461,VAL462,VAL463,VAL464,VAL465,VAL466,VAL467,VAL468,VAL469,VAL470,VAL471,VAL472,VAL473,VAL474,VAL475,VAL476,VAL477,VAL478,VAL479,VAL480,VAL481,VAL482,VAL483,VAL484,VAL485,VAL486,VAL487,VAL488,VAL489,VAL490,VAL491,VAL492,VAL493,VAL494,VAL495,VAL496,VAL497,VAL498,VAL499,VAL500,VAL501,VAL502,VAL503,VAL504,VAL505,VAL506,VAL507,VAL508,VAL509,VAL510,VAL511,VAL512);
    a2 = UNNEST(:seq, :vals) AS TAB("SEQ", "VALUE");
    persons_with_distance = SELECT 
        a1."PERSON_ID" AS "PERSON_ID", 
        SUM ((a1."VALUE"-a2."VALUE")*(a1."VALUE"-a2."VALUE")) AS "DISTANCE"
        FROM "PERSON_EMBEDDINGS" AS a1
        INNER JOIN :a2 AS a2
        ON a1."SEQ" = a2."SEQ"
        GROUP BY a1."PERSON_ID";
    persons = SELECT 
        p."ID",
        "FIRST_SEEN_ON",
        "LAST_SEEN_ON"
        FROM :persons_with_distance AS distance
        INNER JOIN "PERSON" AS p 
        ON distance."PERSON_ID" = p."ID"
        WHERE distance."DISTANCE" <= :threshold;
END

CREATE COLUMN TABLE "SYSTEM"."PERSON_IN_IMAGE" ("PERSON_ID" BIGINT CS_FIXED, "IMAGE_ID" BIGINT CS_FIXED, PRIMARY KEY INVERTED VALUE ("PERSON_ID", "IMAGE_ID")) UNLOAD PRIORITY 5  AUTO MERGE ;
ALTER TABLE "SYSTEM"."PERSON_IN_IMAGE" ADD FOREIGN KEY ( "PERSON_ID" ) REFERENCES "SYSTEM"."PERSON" ("ID") ON UPDATE RESTRICT ON DELETE RESTRICT;
ALTER TABLE "SYSTEM"."PERSON_IN_IMAGE" ADD FOREIGN KEY ( "IMAGE_ID" ) REFERENCES "SYSTEM"."IMAGE" ("ID") ON UPDATE RESTRICT ON DELETE RESTRICT;





